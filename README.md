# python-external-secrets

This project is a baseline demonstration of a python [12 factor](https://12factor.net/) app integrated with Secrets Manager.

It's strongly recommended that you look at the original article this is based on as you may want to use trusted compute rather than the `apikey` approach outlined in this article.

https://0x58.medium.com/ibm-cloud-secrets-manager-and-the-external-secrets-operator-1c94234993b6

Both are satisfactory but one may be prefered over the other depending on your organisations security posture.

You may also want to review the external-secrets-manager [IBM secret store documentation](https://external-secrets.io/v0.7.2/provider/ibm-secrets-manager/)

To use this repository:

1. Create an instance of secret manager as outlined in the [article](https://0x58.medium.com/ibm-cloud-secrets-manager-and-the-external-secrets-operator-1c94234993b6)

2. Create an IAM secret for an IBM Cloud Object Storage instance following this [tutorial](https://cloud.ibm.com/docs/secrets-manager?topic=secrets-manager-iam-credentials&interface=ui)
   For terraform automation scenarios please review the [secret manager provider](https://registry.terraform.io/providers/IBM-Cloud/ibm/latest/docs/data-sources/secrets_manager_secret) and the [IAM provider](https://registry.terraform.io/providers/IBM-Cloud/ibm/latest/docs/resources/iam_service_api_key).

   This demonstration used the standard expiry of 2 months.

3. Update the `external-secret.yaml` secret key created in step 2. This links together the actual secret generated by the secret manager and kubernetes.
   ```yaml
   remoteRef:
      key: iam_credentials/5118b48f-xxxx-xxxx-xxxx-a453f6af6a94
   ```

4. Update the `secret-store.yaml` with your service endpoint. This tells the external-secret manager in kubernetes where to get secrets from.
   ```yaml
   ibm:
      serviceUrl: https://be8f9225-xxxx-xxxx-xxxx-b9d3f4741b0f.eu-de.secrets-manager.appdomain.cloud
   ```
   You can use ` ibmcloud resource service-instance "SECRET-MANAGER-SERVICE-NAME" --output json`

5. Deploy the helm chart
   ```bash
   helm repo add external-secrets https://charts.external-secrets.io

   helm install external-secrets \
      external-secrets/external-secrets \
      -n external-secrets \
      --create-namespace \
      --set installCRDs=true
   ```

5. Follow `The Authentication` section in the [article](https://0x58.medium.com/ibm-cloud-secrets-manager-and-the-external-secrets-operator-1c94234993b6) to generate an key that will enable the external-secret provider to authorise with the secret manager instance.
   You should finish at the command 
   ```
   kubectl create secret generic secret-api-key \
    --from-literal=apiKey='API_KEY_VALUE' -n external-secrets
   ```

6. Apply the secret store 
   ```
      kubectl create -f secret-store.yaml
   ```

7. Create a namespace and create the external secret and the additional config stored in config secrets.
```bash
   kubectl create ns python-space
   kubectl apply external-secret.yaml -n python-space
   kubectl apply config-secrets.yaml -n python-space
```

8. To run the container in a local dev flow create a `.env` file with the following content:
   ```
   COS_CREDENTIAL=API-KEY-GENERATED-BY-SECRET-MANAGER OR MANUALLY
   COS_ENDPOINT=https://s3.eu-gb.cloud-object-storage.appdomain.cloud
   COS_AUTH_ENDPOINT=https://iam.bluemix.net/oidc/token
   COS_SERVICE_INSTANCE_ID=542ea7ad-xxxx-xxx-xxx-b591ff357b36
   ```

9. Build and run the continer
   ```
   docker build -t registry/repo/mypy .
   docker run --env-file .env registry/repo/mypy
   ```

10. Push the image to a registery and run the pod in the cluster.
    ```
    docker push registry/repo/mypy
    ```
11. Edit the `pod.yaml` with the container location
   ```yaml
   image: registry/repo/mypy
   ```
12. Create the pod on the cluster
   ```
   kubectl create -f pod.yaml
   ```
13. The logs for the pod should contain a list of buckets on the service.
   ```
   Retrieving list of buckets
   Bucket Name: xxxxx
   ```

Helpful commands:

Get the cos instance information
```
ibmcloud resource service-instances
ibmcloud resource service-instance --id nameofstorage
```

